{% extends 'base.html' %}
{% load static humanize %}

{% block title %}Feedback · Glamup Nails{% endblock %}

{% block head_extra %}
<style>
  .page-wrap{ padding-top:.5rem; padding-bottom:2rem; }

  /* Order summary */
  .thumb{
    width:80px;height:80px;border-radius:10px;object-fit:cover;
    border:2px solid var(--edge);
  }
  .kv{
    display:grid; grid-template-columns:1fr 1fr 1fr 1fr;
    column-gap:1rem; align-items:center;
  }
  .kv>div{ border-left:2px solid var(--edge); padding-left:1rem; font-size:1.08rem; }
  .kv>div:first-child{ border-left:none; padding-left:0; }
  .total-col{ text-align:left; }

  .title-olive{ font-weight:800; font-size:1.25rem; color:#24301f; }

  /* Rating stars (clickable) */
  .rating{ display:flex; align-items:center; gap:.25rem; }
  .star-btn{
    cursor:pointer; user-select:none;
    color:#c5c084;
    transition: transform .06s ease;
  }
  .star-btn:hover{ transform:scale(1.1); }
  .star-btn i{ font-size:1.5rem; line-height:1; }
  .star-btn.filled i{ color:#f1c40f; }  /* sao đã chọn */
  .star-label{ font-weight:800; color:#24301f; margin-bottom:.4rem; }

  /* Add media */
  .add-box{
    border:2px solid var(--edge); border-radius:10px; height:56px;
    display:grid; place-items:center; background:transparent;
    color:#24301f; font-weight:800;
  }
  .add-box input[type="file"]{ display:none; }
  .add-box:hover{ background:var(--surface); }

  /* Comment */
  textarea.form-control.comment-area{
    background:#fffef9; border:2px solid var(--edge); border-radius:10px;
    min-height:120px; resize:none; overflow:hidden; transition:height .2s ease;
  }
</style>
{% endblock %}

{% block content %}
<div class="container page-wrap">

  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- ORDER SUMMARY -->
    <div class="card-soft p-3 mb-4">
      <div class="d-flex align-items-center gap-3">
        <img src="{{ order.image_url }}" alt="product" class="thumb">
        <div class="flex-grow-1 kv">
          <div>
            <div class="fw-bold">{{ order.service_name }}</div>
            <div class="fw-bold">{{ order.price|intcomma }} VND</div>
          </div>
          <div>
            <div class="fw-bold">Booking code</div>
            <div>#{{ order.code }}</div>
          </div>
          <div>
            <div>At: <span class="fw-bold">{{ order.branch_name }}</span></div>
            <div>
              Time:
              <span class="fw-bold">
                {{ order.start_date|date:"d/m/Y" }} {{ order.start_time|time:"H:i" }}
              </span>
            </div>
          </div>
          <div class="total-col">
            <div class="fw-bold">Totals</div>
            <div class="fw-bold fs-5">{{ order.total|intcomma }} VND</div>
          </div>
        </div>
      </div>
    </div>

    <!-- RATINGS -->
    <div class="row g-4 align-items-start mb-3">

      <!-- Product rating -->
      <div class="col-md-6">
        <div class="star-label">Service Quality</div>
        <div class="rating" data-input="#id_product_rating">
          <span class="star-btn"><i class="bi bi-star"></i></span>
          <span class="star-btn"><i class="bi bi-star"></i></span>
          <span class="star-btn"><i class="bi bi-star"></i></span>
          <span class="star-btn"><i class="bi bi-star"></i></span>
          <span class="star-btn"><i class="bi bi-star"></i></span>
        </div>
        <input type="hidden" name="product_rating" id="id_product_rating" value="0">
      </div>

      <!-- Service rating -->
      <div class="col-md-6">
        <div class="star-label">Service Experience</div>
        <div class="rating" data-input="#id_service_rating">
          <span class="star-btn"><i class="bi bi-star"></i></span>
          <span class="star-btn"><i class="bi bi-star"></i></span>
          <span class="star-btn"><i class="bi bi-star"></i></span>
          <span class="star-btn"><i class="bi bi-star"></i></span>
          <span class="star-btn"><i class="bi bi-star"></i></span>
        </div>
        <input type="hidden" name="service_rating" id="id_service_rating" value="0">
      </div>
    </div>

    <!-- MEDIA -->
    <div class="row g-4 mb-4">
      <div class="col-md-6">
        <label class="add-box w-100">
          Add photo
          <input id="id_photo" type="file" name="photo" accept="image/*">
        </label>
        <div id="photo-preview" class="mt-2" style="display:none">
          <img id="photo-img" src="" alt="photo preview"
               style="max-width:220px;border-radius:10px;border:2px solid var(--edge)">
        </div>

        {# nếu đã có ảnh cũ thì show luôn #}
        {% if existing_photo_url %}
          <div class="mt-2">
            <img src="{{ existing_photo_url }}" alt="uploaded photo"
                 style="max-width:220px;border-radius:10px;border:2px solid var(--edge)">
          </div>
        {% endif %}
      </div>

      <div class="col-md-6">
        <label class="add-box w-100">
          Add video
          <input id="id_video" type="file" name="video" accept="video/*,image/*">
        </label>

        <div id="video-preview" class="mt-2" style="display:none">
          <video id="video-el" controls
                 style="max-width:260px;border-radius:10px;border:2px solid var(--edge)"></video>
          <img id="video-as-image" src="" alt=""
               style="display:none;max-width:220px;border-radius:10px;border:2px solid var(--edge)">
        </div>

        {% if existing_video_url %}
          <div class="mt-2">
            <video src="{{ existing_video_url }}" controls
                   style="max-width:260px;border-radius:10px;border:2px solid var(--edge)"></video>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- COMMENT + SAVE -->
    <div class="mb-2 title-olive">Comment:</div>
    <textarea name="comment" class="form-control comment-area mb-4" placeholder=""></textarea>

    <div class="text-end">
      <button type="submit" class="btn btn-brand px-4">Save</button>
    </div>

  </form>
</div>
{% endblock %}

{% block body_extra %}
<script>
  // ===== Auto-resize textarea =====
  document.addEventListener('input', function(e){
    if (e.target.tagName && e.target.tagName.toLowerCase() === 'textarea'){
      e.target.style.height = 'auto';
      e.target.style.height = e.target.scrollHeight + 'px';
    }
  });

  // ===== Star rating (giữ logic cũ) =====
  function bindRating(ratingEl){
    const inputSel   = ratingEl.getAttribute('data-input');
    const hiddenInput = document.querySelector(inputSel);
    const stars      = Array.from(ratingEl.querySelectorAll('.star-btn'));

    function paint(n){
      stars.forEach(function(btn, idx){
        const icon = btn.querySelector('i');
        if (idx < n){
          btn.classList.add('filled');
          icon.className = 'bi bi-star-fill';
        } else {
          btn.classList.remove('filled');
          icon.className = 'bi bi-star';
        }
      });
    }

    stars.forEach(function(btn, idx){
      btn.addEventListener('click', function(){
        const value = idx + 1;
        paint(value);
        if (hiddenInput){
          hiddenInput.value = value;
        }
      });
    });

    const init = hiddenInput ? parseInt(hiddenInput.value || '0', 10) : 0;
    paint(init > 0 ? init : 0);
  }

  document.addEventListener('DOMContentLoaded', function(){
    // Kích hoạt rating
    document.querySelectorAll('.rating').forEach(bindRating);

    // ===== Live preview: PHOTO =====
    const photoInput = document.getElementById('id_photo');
    const photoBox   = document.getElementById('photo-preview');
    const photoImg   = document.getElementById('photo-img');

    if (photoInput && photoBox && photoImg){
      photoInput.addEventListener('change', function(){
        const f = photoInput.files && photoInput.files[0];
        if (!f || !f.type.startsWith('image/')){
          photoBox.style.display = 'none';
          return;
        }
        const reader = new FileReader();
        reader.onload = function(ev){
          photoImg.src = ev.target.result;
          photoBox.style.display = 'block';
        };
        reader.readAsDataURL(f);
      });
    }

    // ===== Live preview: VIDEO hoặc ảnh ở ô video =====
    const videoInput = document.getElementById('id_video');
    const videoBox   = document.getElementById('video-preview');
    const videoEl    = document.getElementById('video-el');
    const videoImg   = document.getElementById('video-as-image');

    if (videoInput && videoBox && videoEl && videoImg){
      videoInput.addEventListener('change', function(){
        const f = videoInput.files && videoInput.files[0];
        if (!f){
          videoBox.style.display = 'none';
          return;
        }
        const url = URL.createObjectURL(f);
        videoBox.style.display = 'block';

        if (f.type.startsWith('video/')){
          // hiển thị video
          videoEl.src = url;
          videoEl.style.display = 'block';
          videoImg.style.display = 'none';
        } else if (f.type.startsWith('image/')){
          // nếu user chọn ảnh ở ô video
          videoEl.pause();
          videoEl.removeAttribute('src');
          videoEl.load();
          videoEl.style.display = 'none';

          videoImg.src = url;
          videoImg.style.display = 'block';
        } else {
          videoBox.style.display = 'none';
        }
      });
    }
  });
</script>
{% endblock %}

{% extends "base.html" %}
{% load static %}

{% block title %}Services ¬∑ GlamUp Nails{% endblock %}

{% block head_extra %}
<style>

  .wrap{max-width:1200px;margin:24px auto 72px;padding:0 16px;color:var(--ink)}

  /* Banner ri√™ng cho trang Services */
  .services-hero{margin:0 0 18px;border:4px solid var(--brand);border-radius:16px;overflow:hidden;position:relative;}
  .services-hero-img{width:100%;height:260px;object-fit:cover;display:block;}
  .services-hero-overlay{position:absolute;inset:0;display:flex;align-items:flex-end;padding:12px 16px;background:linear-gradient(180deg,rgba(0,0,0,0) 45%,rgba(0,0,0,.35) 100%);}
  .services-hero-title{color:#fff;font-weight:900;font-size:clamp(20px,2.2vw,28px);}
  .services-hero-desc{color:#fff;opacity:.95;font-weight:700;font-size:clamp(12px,1.5vw,14px);}

 /* Layout */
.layout{
  display:grid;
  grid-template-columns:260px 1fr;
  gap:22px;
}
@media (max-width:960px){
  .layout{
    grid-template-columns:1fr;
  }
}

/* Sidebar */
.side{
  border:1px solid var(--edge);
  border-radius:14px;
  padding:16px;
  background:#fff;

  /* l√†m sticky */
  position:sticky;
  top:100px;          /* kho·∫£ng c√°ch v·ªõi m√©p tr√™n ‚Äì ch·ªânh 80/90/110 tu·ª≥ chi·ªÅu cao header */
  align-self:flex-start;
}

/* Tr√™n m√†n nh·ªè th√¨ b·ªè sticky cho d·ªÖ d√πng */
@media (max-width:960px){
  .side{
    position:static;
  }
}
  .side h3{margin:4px 0 12px;font-weight:900}
  .cat-btn{
    width:100%;display:block;text-align:left;border:2px solid #8b9361;background:#fff;color:#8b9361;
    border-radius:12px;padding:10px 14px;font-weight:900;margin-bottom:10px;cursor:pointer
  }
  .cat-btn.active,.cat-btn:hover{background:#8b9361;color:#fff}

  /* Controls */
  .controls{display:grid;grid-template-columns:1fr 220px;gap:12px;margin-bottom:14px}
  @media (max-width:560px){ .controls{grid-template-columns:1fr} }
  .search, select{
    border:2px solid #8b9361;border-radius:12px;padding:10px 14px;background:#fff
  }

  /* Grid + Card */
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
  @media (max-width:1000px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:640px){ .grid{grid-template-columns:1fr} }

  .card{border:none;border-radius:14px;background:#fff;overflow:hidden;box-shadow:0 3px 3px rgba(0,0,0,.04);transition:all .25s ease;}
  .card:hover{
    transform:translateY(-4px);
    box-shadow:0 10px 22px rgba(0,0,0,0.10);
    border-color:#a5aa7f;
  }

  .thumb{width:100%;aspect-ratio:1/1;object-fit:cover;display:block}

  .body{padding:8px 12px}
  .c-row{display:flex;justify-content:space-between;gap:10px;align-items:center}
  .name{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:70%}
  .price{font-weight:900}
  .c-foot{display:flex;justify-content:space-between;align-items:center;margin-top:6px}

  /* NOTE: kh·ªëi hi·ªÉn th·ªã ‚Äú‚òÖ 4.7‚Äù + s·ªë review */
  .rating-box{font-size:.85rem;font-weight:600;color:#2b3220;}
  .rating-main{display:flex;align-items:center;gap:4px;line-height:1;}
  .rating-main .star{color:#f5b800;font-size:.95rem;}
  .rating-main .score{font-weight:800;}
  .rating-meta{font-size:.75rem;color:#6c6f55;margin-top:1px;}

  .hide{display:none !important}
  .empty{padding:18px;border:2px dashed var(--brand-strong);border-radius:12px;background:#fff}
</style>
{% endblock %}

{% block content %}
<div class="wrap">

<!-- Banner -->
<section class="services-hero" aria-label="Services banner">
  <img class="services-hero-img"
       src="{% static 'img/services_banner.jpg' %}"
       alt="Glamup Nails Collection">
</section>


  <div class="layout">
    <!-- Sidebar -->
    <aside class="side" aria-label="Categories">
      <h3>Category</h3>
      <button type="button" class="cat-btn active" data-cat="all">All</button>
      <button type="button" class="cat-btn" data-cat="manicure">Manicure</button>
      <button type="button" class="cat-btn" data-cat="pedicure">Pedicure</button>
      <button type="button" class="cat-btn" data-cat="more">More</button>
    </aside>

    <!-- Main -->
    <section>
      <div class="controls">
        <input id="q" class="search" type="search" placeholder="Search services‚Ä¶" data-bs-toggle="dropdown" aria-label="Search services">
        <select id="sort" aria-label="Sort by">
          <option value="">Sort by: Default</option>
          <option value="name_asc">Name (A ‚Üí Z)</option>
          <option value="name_desc">Name (Z ‚Üí A)</option>
          <option value="price_asc">Price (Low ‚Üí High)</option>
          <option value="price_desc">Price (High ‚Üí Low)</option>
        </select>
      </div>

      <div id="grid" class="grid">
        {% for s in services %}
          <article class="card"
                   data-category="{{ s.category }}"
                   data-name="{{ s.name }}"
                   data-price="{{ s.price|floatformat:0 }}"
                   data-slug="{{ s.slug }}">
            <img class="thumb" src="{{ s.thumbnail_url }}" alt="{{ s.name }}">

            <div class="body">
              <div class="c-row">
                <div class="name">{{ s.name }}</div>
                <div class="price">{{ s.price|floatformat:0 }}‚Ç´</div>
              </div>

              <div class="c-foot">
                <!-- NOTE: ‚≠ê + ƒëi·ªÉm trung b√¨nh n·∫±m d∆∞·ªõi ·∫£nh -->
                <div class="rating-box">
                  {% if s.total_reviews > 0 %}
                    <div class="rating-main"
                         aria-label="{{ s.avg_rating|floatformat:1 }} out of 5">
                      <span class="star">‚òÖ</span>
                      <span class="score">{{ s.avg_rating|floatformat:1 }}</span>
                    </div>
                    <div class="rating-meta">
                      {{ s.total_reviews }} review{{ s.total_reviews|pluralize:"s" }}
                    </div>
                  {% else %}
                    <div class="rating-meta">No rating yet</div>
                  {% endif %}
                </div>

                <a class="btn btn-brand btn-sm"
                   href="{% url 'main:service_detail' s.slug %}">
                  Book Now
                </a>
              </div>
            </div>
          </article>
        {% empty %}
          <div class="empty">No services available yet.</div>
        {% endfor %}
      </div>
              {% if page_obj.paginator.num_pages > 1 %}
      <nav class="mt-4">
        <ul class="pagination justify-content-center">

          {# Prev #}
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.previous_page_number }}">¬´ Prev</a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">¬´ Prev</span>
            </li>
          {% endif %}

          {# C√°c s·ªë trang #}
          {% for num in page_obj.paginator.page_range %}
            {% if num == page_obj.number %}
              <li class="page-item active">
                <span class="page-link"
                      style="background-color:var(--brand);border-color:var(--brand);">
                  {{ num }}
                </span>
              </li>
            {% else %}
              <li class="page-item">
                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
              </li>
            {% endif %}
          {% endfor %}

          {# Next #}
          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next ¬ª</a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">Next ¬ª</span>
            </li>
          {% endif %}

        </ul>
      </nav>
      {% endif %}
    </section>
  </div>
</div>

<script>
(() => {
  const $  = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
  const normalize = s => (s||'').toString().toLowerCase().trim();

  const grid     = $('#grid');
  const catBtns  = $$('.cat-btn');
  const sortSel  = $('#sort');
  const searchEl = $('#q');

  const heroImg   = $('#heroImg');
  const heroTitle = $('#heroTitle');
  const heroDesc  = $('#heroDesc');
  const HERO_COMMON = "{% static 'images/hero_spring.jpg' %}";

  const state = { cat:'all', sort:'', q:'' };

  function setHero(cat){
    if (!heroImg || !heroTitle || !heroDesc) return; // kh√¥ng c√≥ hero th√¨ th√¥i
    heroImg.src = HERO_COMMON;
    const titleMap = {all:'All', manicure:'Manicure', pedicure:'Pedicure', more:'More'};
    const descMap  = {
        all: "Browse all our latest services and collections.",
        manicure: "Discover our latest spring collection for perfect hands.",
        pedicure: "Pamper your feet with our relaxing pedicure services.",
        more: "Add-on care to complete your beauty routine."
    };
    heroTitle.textContent = titleMap[cat] || 'All';
    heroDesc.textContent  = descMap[cat]  || descMap.all;
  }

  function render(){
    const cards = $$('.card', grid);

    // filter
    cards.forEach(c => {
      const okCat = (state.cat === 'all') ? true : (c.dataset.category === state.cat);
      const okQ   = state.q ? normalize(c.dataset.name).includes(state.q) : true;
      c.classList.toggle('hide', !(okCat && okQ));
    });

    // sort
    const vis = cards.filter(c => !c.classList.contains('hide'));
    const hid = cards.filter(c =>  c.classList.contains('hide'));
    if (state.sort){
      const [key, dir] = state.sort.split('_');
      vis.sort((a,b)=>{
        if(key==='price'){
          const pa = +(a.dataset.price||0), pb = +(b.dataset.price||0);
          return dir==='asc' ? pa-pb : pb-pa;
        }else{
          const na=(a.dataset.name||'').toLowerCase(), nb=(b.dataset.name||'').toLowerCase();
          if(na<nb) return dir==='asc'?-1:1;
          if(na>nb) return dir==='asc'? 1:-1;
          return 0;
        }
      });
    }
    vis.forEach(c => grid.appendChild(c));
    hid.forEach(c => grid.appendChild(c));

    setHero(state.cat);
  }

  // events
  catBtns.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      catBtns.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      state.cat = btn.dataset.cat;

      // l∆∞u category v√†o hash ƒë·ªÉ l·∫ßn reload v·∫´n nh·ªõ
      location.hash = '#'+state.cat;

      // üîÅ reset pagination v·ªÅ trang 1 (xo√° ?page=... r·ªìi reload)
      const url = new URL(window.location.href);
      if (url.searchParams.has('page') && url.searchParams.get('page') !== '1') {
        // c√°ch 1: xo√° h·∫≥n param page ‚Üí Django m·∫∑c ƒë·ªãnh page 1
        url.searchParams.delete('page');

        // (hash #manicure v·∫´n n·∫±m tr√™n url)
        window.location.href = url.toString();
        return; // trang s·∫Ω reload, kh√¥ng c·∫ßn render ·ªü d∆∞·ªõi
      }

      // n·∫øu ƒë√£ ·ªü page 1 r·ªìi th√¨ ch·ªâ c·∫ßn render l·∫°i
      render();
    });
  });

  sortSel.addEventListener('change', e => { state.sort = e.target.value||''; render(); });
  searchEl.addEventListener('input', e => { state.q = normalize(e.target.value); render(); });

  // init
  (function init(){
    if (location.hash){
      const cat = location.hash.slice(1);
      const match = catBtns.find(b => b.dataset.cat===cat);
      if (match) match.click(); else render();
    } else {
      render();
    }
  })();
})();
</script>
{% endblock %}
